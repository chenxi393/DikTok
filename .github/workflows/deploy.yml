# ä¸€å¥è¯æ¦‚æ‹¬ï¼šæ¨é€ä»£ç åˆ°mainåæ„å»ºé•œåƒå‘å¸ƒåˆ°dockerhubï¼Œåœ¨é‡æ–°è¿è¡ŒæœåŠ¡å™¨docker
name: DikToké•œåƒæ‰“åŒ…ğŸ˜
on:
  push:
    branches: [main] # mainåˆ†æ”¯ä¸Špushè§¦å‘éƒ¨ç½²

jobs:
  build-image-deploy:
    name: æ„å»ºé•œåƒğŸ¤¦â€â™‚ï¸
    # åœ¨ubuntuä¸Šè¿›è¡Œæ„å»ºæ“ä½œ
    runs-on: ubuntu-latest

    steps:
      - name: è¯»å–ä»“åº“å†…å®¹ğŸ˜‰
        uses: actions/checkout@v4

      - name: Docker metağŸ¤¦â€â™€ï¸
        id: meta
        uses: docker/metadata-action@v4.3.0
        with:
          # list of Docker images to use as base name for tags
          images: chenxi393/diktok

      - name: ç™»å½•DockerHubğŸ’•
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Build and Push
        uses: docker/build-push-action@v4.0.0
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      # é€šè¿‡sshè¿œç¨‹æ‰§è¡Œå‘½ä»¤é‡å¯vpsä¸Šçš„æœåŠ¡
      - name: SSH Remote CommandsğŸ¤£
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }} # Secretsä¸­çš„é…ç½®ï¼švps IPåœ°å€
          username: ${{ secrets.REMOTE_USER }} # Secretsä¸­çš„é…ç½®ï¼švps ç™»å½•ç”¨æˆ·å
          key: ${{ secrets.SERVER_SSH_KEY }} # Secretsä¸­çš„é…ç½®ï¼švps ä¸Šåˆ›å»ºçš„ssh keyçš„ç§é’¥å†…å®¹
          script: cd ${{ secrets.PATH }} && make down && make pull && make up

      - name: WebhookğŸ˜‚
        run:
          curl www.baidu.com
          # curl '${{ secrets.WEBHOOK_URL }}&target=${{ env.CONTAINER }}'
